<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laser Mirror Toys</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.js"></script>
  <script src="https://unpkg.com/p5.js-svg@1.5.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:     #f5f4f0;
      --panel:  #ffffff;
      --border: #e0deda;
      --text:   #1a1a18;
      --muted:  #888880;
      --accent: #e63412;
    }

    html, body {
      width: 100%; height: 100%;
      background: var(--bg);
      font-family: 'DM Sans', sans-serif;
      color: var(--text);
      overflow: hidden;
    }

    /* ── Layout ────────────────────────────────────── */
    .container {
      display: flex;
      width: 100vw;
      height: 100vh;
    }

    /* Canvas side */
    #canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Grain overlay */
    #canvas-container::after {
      content: '';
      position: absolute; inset: 0;
      pointer-events: none;
      opacity: 0.025;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      background-size: 128px;
    }

    /* p5 canvas wrapper */
    #p5-wrap {
      line-height: 0;
    }
    #p5-wrap canvas {
      display: block;
    }

    /* Controls panel */
    .controls-box {
      width: 240px;
      flex-shrink: 0;
      background: var(--panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 28px 20px;
      overflow-y: auto;
    }

    /* ── Typography ────────────────────────────────── */
    .panel-title {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    h2 {
      font-size: 20px;
      font-weight: 500;
      letter-spacing: -0.02em;
      line-height: 1.1;
      margin-bottom: 28px;
    }

    h2 span { color: var(--accent); }

    .control-label {
      display: block;
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    /* ── Divider ───────────────────────────────────── */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 18px 0;
    }

    /* ── Control groups ────────────────────────────── */
    .control-group {
      margin-bottom: 16px;
    }

    /* ── Select ────────────────────────────────────── */
    select {
      width: 100%;
      padding: 9px 10px;
      border: 1.5px solid var(--border);
      background: transparent;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--text);
      cursor: pointer;
      outline: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23888880' stroke-width='1.5'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }
    select:focus { border-color: var(--text); }

    /* ── Color + number rows ───────────────────────── */
    .color-weight-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .color-section { flex: 2; }
    .weight-section { flex: 1; }

    .sub-label {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-bottom: 4px;
      display: block;
    }

    input[type="color"] {
      width: 100%;
      height: 40px;
      padding: 2px;
      border: 1.5px solid var(--border);
      cursor: pointer;
      background: transparent;
    }
    input[type="color"]:hover { border-color: var(--text); }

    input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1.5px solid var(--border);
      background: transparent;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--text);
      outline: none;
    }
    input[type="number"]:focus { border-color: var(--text); }

    /* ── Checkbox ──────────────────────────────────── */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--text);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    input[type="checkbox"] {
      width: 16px; height: 16px;
      cursor: pointer;
      accent-color: var(--text);
    }

    /* ── Sliders (for lm6 controls) ────────────────── */
    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .slider-row input[type=range] {
      flex: 1; -webkit-appearance: none;
      height: 2px; background: var(--border); border-radius: 1px; outline: none; cursor: pointer;
    }
    .slider-row input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%;
      background: var(--text); cursor: pointer; transition: background 0.15s;
    }
    .slider-row input[type=range]:hover::-webkit-slider-thumb { background: var(--accent); }
    .slider-val {
      font-family: 'DM Mono', monospace; font-size: 10px;
      color: var(--muted); width: 30px; text-align: right;
    }

    /* ── Buttons ───────────────────────────────────── */
    .btn {
      display: block;
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--text);
      background: transparent;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      margin-bottom: 8px;
    }
    .btn:hover { background: var(--text); color: white; }

    .btn-accent {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .btn-accent:hover { background: #c22a0e; border-color: #c22a0e; color: white; }

    /* ── Sections that toggle visibility ───────────── */
    #controls-2d, #controls-3d { display: flex; flex-direction: column; }
    #controls-3d { display: none; }

    /* ── Stat rows ─────────────────────────────────── */
    .stat-row {
      display: flex; justify-content: space-between;
      font-family: 'DM Mono', monospace; font-size: 9px;
      color: var(--muted); margin-bottom: 6px;
    }
    .stat-row span:last-child { color: var(--text); }

    /* ── Hint ──────────────────────────────────────── */
    .hint {
      margin-top: auto;
      padding-top: 18px;
      font-size: 9px;
      color: var(--muted);
      line-height: 1.7;
      font-family: 'DM Mono', monospace;
    }
    .hint strong { color: var(--text); font-weight: 400; }

    /* ── Canvas prompt ─────────────────────────────── */
    .canvas-prompt {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      pointer-events: none;
      opacity: 0.7;
    }
    #canvas-prompt.hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">

    <!-- ── Canvas area ─────────────────────────────── -->
    <div id="canvas-container">
      <div id="p5-wrap">
        <!-- p5 canvas mounts here -->
      </div>
      <!-- Three.js canvas mounts directly into #canvas-container -->
      <div class="canvas-prompt" id="canvas-prompt">Click to interact</div>
    </div>

    <!-- ── Controls panel ─────────────────────────── -->
    <div class="controls-box">
      <div class="panel-title">Interactive Toy</div>
      <h2>Laser<br><span>Mirror</span></h2>

      <!-- Toy selector — always visible -->
      <div class="control-group">
        <label class="control-label">Select Toy</label>
        <select id="toySelect">
          <option value="laserMirror0">laserMirror0</option>
          <option value="laserMirror1">laserMirror1</option>
          <option value="laserMirror2">laserMirror2</option>
          <option value="laserMirror3">laserMirror3</option>
          <option value="laserMirror4">laserMirror4</option>
          <option value="laserMirror5">laserMirror5</option>
          <option value="laserMirror6">laserMirror6 — 3D</option>
        </select>
      </div>

      <div class="divider"></div>

      <!-- ── 2D controls ───────────────────────────── -->
      <div id="controls-2d">
        <div class="control-group">
          <label class="control-label">Background</label>
          <input type="color" id="backgroundColor" value="#ffffff">
        </div>

        <div class="control-group">
          <label class="control-label">Laser</label>
          <div class="color-weight-row">
            <div class="color-section">
              <input type="color" id="laserColor" value="#ff0000">
            </div>
            <div class="weight-section">
              <span class="sub-label">Weight</span>
              <input type="number" id="laserWeight" value="2" min="1" max="20" step="0.5">
            </div>
          </div>
        </div>

        <div class="control-group">
          <label class="control-label">Mirror</label>
          <div class="color-weight-row">
            <div class="color-section">
              <input type="color" id="mirrorColor" value="#000000">
            </div>
            <div class="weight-section">
              <span class="sub-label">Weight</span>
              <input type="number" id="mirrorWeight" value="2" min="1" max="20" step="0.5">
            </div>
          </div>
        </div>

        <div class="control-group">
          <label class="checkbox-label">
            <input type="checkbox" id="fillCheckbox">
            Fill
          </label>
        </div>

        <div class="control-group" id="fillColorGroup" style="display:none;">
          <label class="control-label">Fill Color</label>
          <input type="color" id="fillColor" value="#ffff00">
        </div>

        <div class="divider"></div>

        <button class="btn btn-accent" onclick="exportSVG()">Export SVG</button>
      </div>

      <!-- ── 3D controls ───────────────────────────── -->
      <div id="controls-3d">
        <label class="control-label">Mirror Size</label>
        <div class="slider-row">
          <input type="range" id="lm6MirrorSize" min="0.3" max="1.2" value="0.7" step="0.05">
          <span class="slider-val" id="lm6MirrorSizeVal">0.70</span>
        </div>

        <label class="control-label">Grid Spacing</label>
        <div class="slider-row">
          <input type="range" id="lm6GridSpacing" min="1.5" max="5.0" value="2.5" step="0.1">
          <span class="slider-val" id="lm6GridSpacingVal">2.5</span>
        </div>

        <div class="divider"></div>

        <div class="stat-row"><span>Grid</span><span>3 × 3 × 3</span></div>
        <div class="stat-row"><span>Mirrors</span><span>27</span></div>
        <div class="stat-row"><span>Bounces</span><span>27</span></div>

        <div class="divider"></div>

        <button class="btn btn-accent" id="lm6RandomizeBtn">↻ Randomize Path</button>
        <button class="btn" id="lm6ResetBtn">Reset View</button>

        <div class="hint">
          <strong>Drag</strong> to orbit<br>
          <strong>Scroll</strong> to zoom<br>
          <strong>Right-drag</strong> to pan
        </div>
      </div>

    </div><!-- /controls-box -->
  </div><!-- /container -->

  <!-- Sketch files (0–5 are p5, 6 is Three.js) -->
  <script src="laserMirror0.js"></script>
  <script src="laserMirror1.js"></script>
  <script src="laserMirror2.js"></script>
  <script src="laserMirror3.js"></script>
  <script src="laserMirror4.js"></script>
  <script src="laserMirror5.js"></script>
  <script src="laserMirror6.js"></script>

  <script>
    // ============================================
    // GLOBAL SHARED VARIABLES (p5 toys use these)
    // ============================================
    let bgColor, laserColor, mirrorColor, fillColor;
    let laserWeight = 2;
    let mirrorWeight = 2;
    let useFill = false;
    let currentToy = 'laserMirror0';
    let exportMode = false;

    // ============================================
    // P5 SETUP & DRAW
    // ============================================
    function setup() {
      let canvas = createCanvas(600, 600);
      canvas.parent('p5-wrap');
      strokeCap(ROUND);

      bgColor    = color(document.getElementById('backgroundColor').value);
      laserColor = color(document.getElementById('laserColor').value);
      mirrorColor= color(document.getElementById('mirrorColor').value);
      fillColor  = color(document.getElementById('fillColor').value);
      laserWeight = parseFloat(document.getElementById('laserWeight').value);
      mirrorWeight= parseFloat(document.getElementById('mirrorWeight').value);

      setupControlListeners();
    }

    function draw() {
      if (currentToy === 'laserMirror6') return; // Three.js handles its own loop
      background(bgColor);
      switch(currentToy) {
        case 'laserMirror0': drawLaserMirror0(); break;
        case 'laserMirror1': drawLaserMirror1(); break;
        case 'laserMirror2': drawLaserMirror2(); break;
        case 'laserMirror3': drawLaserMirror3(); break;
        case 'laserMirror4': drawLaserMirror4(); break;
        case 'laserMirror5': drawLaserMirror5(); break;
      }
    }

    function mousePressed() {
      if (currentToy === 'laserMirror6') return;
      if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
        switch(currentToy) {
          case 'laserMirror0': laserMirror0_mousePressed(); break;
          case 'laserMirror1': laserMirror1_mousePressed(); break;
          case 'laserMirror2': laserMirror2_mousePressed(); break;
          case 'laserMirror3': laserMirror3_mousePressed(); break;
          case 'laserMirror4': laserMirror4_mousePressed(); break;
          case 'laserMirror5': laserMirror5_mousePressed(); break;
        }
      }
    }

    // ============================================
    // TOY SWITCHING
    // ============================================
    function switchTo(toyName) {
      const was3D = currentToy === 'laserMirror6';
      const is3D  = toyName    === 'laserMirror6';

      currentToy = toyName;

      if (was3D && !is3D) {
        // Unmount Three.js, show p5
        LaserMirror6.unmount();
        document.getElementById('p5-wrap').style.display = '';
        document.getElementById('canvas-prompt').classList.remove('hidden');
        document.getElementById('controls-2d').style.display = 'flex';
        document.getElementById('controls-3d').style.display = 'none';
      } else if (!was3D && is3D) {
        // Hide p5, mount Three.js
        document.getElementById('p5-wrap').style.display = 'none';
        document.getElementById('controls-2d').style.display = 'none';
        document.getElementById('controls-3d').style.display = 'flex';
        LaserMirror6.mount(document.getElementById('canvas-container'));
        document.getElementById('canvas-prompt').classList.add('hidden');
      }
    }

    // ============================================
    // SVG EXPORT (2D only)
    // ============================================
    function exportSVG() {
      if (currentToy === 'laserMirror6') return;

      // Step 1: stop the draw loop and remove the existing canvas
      noLoop();
      exportMode = true;
      let oldCanvas = select('canvas');
      if (oldCanvas) oldCanvas.remove();

      // Step 2: defer SVG canvas creation so DOM has fully cleared
      setTimeout(() => {
        // Null out p5's internal renderer reference so p5.js-svg doesn't try to resize the old one
        if (typeof _renderer !== 'undefined') _renderer = null;
        let svgCanvas = createCanvas(600, 600, SVG);
        svgCanvas.parent('p5-wrap');
        strokeCap(ROUND);
        background(bgColor);
        switch(currentToy) {
          case 'laserMirror0': drawLaserMirror0(); break;
          case 'laserMirror1': drawLaserMirror1(); break;
          case 'laserMirror2': drawLaserMirror2(); break;
          case 'laserMirror3': drawLaserMirror3(); break;
          case 'laserMirror4': drawLaserMirror4(); break;
          case 'laserMirror5': drawLaserMirror5(); break;
        }
        save(currentToy + '.svg');

        // Step 3: restore normal canvas after save has triggered
        setTimeout(() => {
          exportMode = false;
          let done = select('canvas');
          if (done) done.remove();
          setTimeout(() => {
            let canvas = createCanvas(600, 600);
            canvas.parent('p5-wrap');
            strokeCap(ROUND);
            loop();
          }, 50);
        }, 400);
      }, 50);
    }

    // ============================================
    // CONTROL LISTENERS
    // ============================================
    function setupControlListeners() {
      document.getElementById('backgroundColor').addEventListener('input', e => { bgColor = color(e.target.value); });
      document.getElementById('laserColor').addEventListener('input', e => {
        laserColor = color(e.target.value);
        LaserMirror6.updateLaserColor();
      });
      document.getElementById('laserWeight').addEventListener('input', e => { laserWeight = parseFloat(e.target.value); });
      document.getElementById('mirrorColor').addEventListener('input', e => { mirrorColor = color(e.target.value); });
      document.getElementById('mirrorWeight').addEventListener('input', e => { mirrorWeight = parseFloat(e.target.value); });
      document.getElementById('fillColor').addEventListener('input', e => { fillColor = color(e.target.value); });
      document.getElementById('fillCheckbox').addEventListener('change', e => {
        useFill = e.target.checked;
        document.getElementById('fillColorGroup').style.display = useFill ? 'block' : 'none';
      });
      document.getElementById('toySelect').addEventListener('change', e => { switchTo(e.target.value); });

      // 3D-specific controls
      const lm6MirrorSize = document.getElementById('lm6MirrorSize');
      const lm6MirrorSizeVal = document.getElementById('lm6MirrorSizeVal');
      lm6MirrorSize.addEventListener('input', () => {
        const v = parseFloat(lm6MirrorSize.value);
        lm6MirrorSizeVal.textContent = v.toFixed(2);
        LaserMirror6.setMirrorSize(v);
      });

      const lm6GridSpacing = document.getElementById('lm6GridSpacing');
      const lm6GridSpacingVal = document.getElementById('lm6GridSpacingVal');
      lm6GridSpacing.addEventListener('input', () => {
        const v = parseFloat(lm6GridSpacing.value);
        lm6GridSpacingVal.textContent = v.toFixed(1);
        LaserMirror6.setGridSpacing(v);
      });

      document.getElementById('lm6RandomizeBtn').addEventListener('click', () => LaserMirror6.rebuild());
      document.getElementById('lm6ResetBtn').addEventListener('click', () => LaserMirror6.resetView());
    }
  </script>
</body>
</html>
